<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SUMO-Style Free Vocal & Music Studio</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b0f17">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f17; color:#e9eefc; }
    .wrap { max-width: 1050px; margin: 0 auto; padding: 16px; }
    h1 { margin: 8px 0 6px; font-size: 20px; }
    p { margin: 0 0 12px; opacity:.85; line-height:1.35; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px){ .grid2 { grid-template-columns: 1fr 1fr; } }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 12px; }
    label { display:block; margin-bottom: 6px; opacity:.9; font-size: 13px; }
    textarea, select {
      width: 100%; box-sizing: border-box;
      padding: 10px 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35); color:#e9eefc; outline:none;
    }
    textarea { resize: vertical; min-height: 140px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn {
      padding: 10px 14px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color:#e9eefc; cursor:pointer; user-select:none;
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .mini { font-size: 12px; opacity: .78; line-height:1.35; }
    .kpi { font-size: 12px; opacity:.78; margin-top: 8px; }
    .range { width:100%; }
    .pill { display:inline-flex; padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); font-size: 12px; opacity:.9; }
    .warn { color:#ffd48a; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>SUMO-Style Free Vocal & Music Studio</h1>
  <p>Metin + Ã§ok dil + ÅŸive + hÄ±z/pitch + beat. HazÄ±r beat veya kendi mÃ¼ziÄŸin. Beatâ€™i (ve istersen mikrofon vokalini) mix edip indirebilirsin. (Tamamen Ã¼cretsiz / sÄ±nÄ±rsÄ±z)</p>

  <div class="grid grid2">
    <div class="card">
      <label>Metin (seslendirilecek)</label>
      <textarea id="text">Allah'Ä±n selamÄ± Ã¼zerinize olsunâ€¦ BugÃ¼n size efsane bir duyuru var!</textarea>
      <div class="kpi" id="status">HazÄ±r.</div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSpeak">â–¶ï¸ TTS Dinlet</button>
        <button class="btn" id="btnStopSpeak">â¹ï¸ TTS Durdur</button>
        <button class="btn" id="btnSave">ğŸ’¾ Projeyi Kaydet</button>
        <button class="btn" id="btnLoad">ğŸ“‚ KaydÄ± YÃ¼kle</button>
      </div>
      <p class="mini warn" style="margin-top:10px">
        Not: TarayÄ±cÄ± TTS sesini doÄŸrudan MP3â€™e gÃ¶mmek her cihazda mÃ¼mkÃ¼n deÄŸil. Bu stÃ¼dyo TTSâ€™yi dinletir; indirilen kayÄ±t beat + mikrofon iÃ§erir.
      </p>
    </div>

    <div class="card">
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label>Dil</label>
          <select id="lang"></select>
        </div>
        <div>
          <label>Åive / YÃ¶re</label>
          <select id="accent"></select>
        </div>

        <div>
          <label>HÄ±z (TTS Rate) <span class="pill" id="rateVal">1.00</span></label>
          <input id="rate" class="range" type="range" min="0.5" max="2" step="0.05" value="1" />
        </div>

        <div>
          <label>Pitch (Tiz/KalÄ±n) <span class="pill" id="pitchVal">1.00</span></label>
          <input id="pitch" class="range" type="range" min="0" max="2" step="0.05" value="1" />
        </div>

        <div>
          <label>Duygu</label>
          <select id="mood">
            <option>Damar</option>
            <option selected>Duygusal</option>
            <option>HÃ¼zÃ¼nlÃ¼</option>
            <option>Hareketli</option>
            <option>Elektro</option>
            <option>Slow</option>
            <option>Romantik</option>
          </select>
        </div>

        <div>
          <label>Tempo</label>
          <select id="tempo">
            <option value="0.85">Slow</option>
            <option value="1" selected>Normal</option>
            <option value="1.15">Fast</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <label>Fon MÃ¼ziÄŸi KaynaÄŸÄ±</label>
        <div class="row">
          <select id="bgMode">
            <option value="builtIn">HazÄ±r Beat (SÄ±nÄ±rsÄ±z)</option>
            <option value="upload">Kendi MÃ¼ziÄŸim (MP3/WAV yÃ¼kle)</option>
          </select>
          <input id="bgFile" type="file" accept="audio/*" style="flex:1" />
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-top:12px">
          <div>
            <label>Beat Tipi</label>
            <select id="beatType">
              <option value="pop" selected>Pop</option>
              <option value="trap">Trap</option>
              <option value="arabesk">Arabesk (Damar)</option>
              <option value="lofi">Lo-fi</option>
            </select>
          </div>
          <div>
            <label>Beat Åiddeti <span class="pill" id="beatVal">0.60</span></label>
            <input id="beatGain" class="range" type="range" min="0" max="1" step="0.01" value="0.6" />
          </div>
          <div>
            <label>MÃ¼zik HÄ±zÄ± <span class="pill" id="bgSpeedVal">1.00</span></label>
            <input id="bgSpeed" class="range" type="range" min="0.5" max="1.5" step="0.01" value="1" />
          </div>
          <div>
            <label>MÃ¼zik Ses Seviyesi <span class="pill" id="bgGainVal">0.55</span></label>
            <input id="bgGain" class="range" type="range" min="0" max="1" step="0.01" value="0.55" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnBgPlay">ğŸ¶ Fon BaÅŸlat</button>
          <button class="btn" id="btnBgStop">â¹ï¸ Fon Durdur</button>
          <button class="btn" id="btnMic">ğŸ™ï¸ Mikrofon AÃ§/Kapat</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnRec">âºï¸ Mix KaydÄ± BaÅŸlat</button>
          <button class="btn" id="btnRecStop" disabled>â¹ï¸ KaydÄ± Durdur</button>
          <a class="btn" id="dl" style="display:none" download="sumo_mix.webm">â¬‡ï¸ Ä°ndir</a>
        </div>

        <p class="mini" style="margin-top:10px">
          KullanÄ±m: Fon BaÅŸlat â†’ (istersen Mikrofon aÃ§) â†’ Mix KaydÄ± BaÅŸlat â†’ KaydÄ± Durdur â†’ Ä°ndir
        </p>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const LANGS = [
    { label: "TÃ¼rkÃ§e", value: "tr-TR", accents: ["Ä°stanbul", "Ege", "Karadeniz", "DoÄŸu", "GÃ¼neydoÄŸu"] },
    { label: "English", value: "en-US", accents: ["US", "UK", "AU"] },
    { label: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", value: "ar-SA", accents: ["KÃ¶rfez", "MÄ±sÄ±r", "Åam", "MaÄŸrip"] },
    { label: "Deutsch", value: "de-DE", accents: ["DE", "AT", "CH"] },
    { label: "FranÃ§ais", value: "fr-FR", accents: ["FR", "CA"] },
    { label: "AzÉ™rbaycan dili", value: "az-AZ", accents: ["BakÃ¼", "Gence"] },
    { label: "ÙØ§Ø±Ø³ÛŒ", value: "fa-IR", accents: ["Tahran", "Åiraz"] },
    { label: "Ğ ÑƒÑÑĞºĞ¸Ğ¹", value: "ru-RU", accents: ["Moskova", "SPB"] },
    { label: "EspaÃ±ol", value: "es-ES", accents: ["ES", "MX"] },
    { label: "Italiano", value: "it-IT", accents: ["IT"] },
  ];

  const $ = (id) => document.getElementById(id);
  const text = $("text");
  const lang = $("lang");
  const accent = $("accent");
  const rate = $("rate");
  const pitch = $("pitch");
  const rateVal = $("rateVal");
  const pitchVal = $("pitchVal");
  const mood = $("mood");
  const tempo = $("tempo");
  const status = $("status");

  const bgMode = $("bgMode");
  const bgFile = $("bgFile");
  const beatType = $("beatType");
  const beatGain = $("beatGain");
  const beatVal = $("beatVal");
  const bgSpeed = $("bgSpeed");
  const bgSpeedVal = $("bgSpeedVal");
  const bgGain = $("bgGain");
  const bgGainVal = $("bgGainVal");

  const btnSpeak = $("btnSpeak");
  const btnStopSpeak = $("btnStopSpeak");
  const btnSave = $("btnSave");
  const btnLoad = $("btnLoad");

  const btnBgPlay = $("btnBgPlay");
  const btnBgStop = $("btnBgStop");
  const btnMic = $("btnMic");

  const btnRec = $("btnRec");
  const btnRecStop = $("btnRecStop");
  const dl = $("dl");

  function fillLangs() {
    lang.innerHTML = LANGS.map(l => `<option value="${l.value}">${l.label}</option>`).join("");
    lang.value = "tr-TR";
    fillAccents();
  }
  function fillAccents() {
    const l = LANGS.find(x => x.value === lang.value) || LANGS[0];
    accent.innerHTML = l.accents.map(a => `<option value="${a}">${a}</option>`).join("");
  }
  function syncLabels() {
    rateVal.textContent = Number(rate.value).toFixed(2);
    pitchVal.textContent = Number(pitch.value).toFixed(2);
    beatVal.textContent = Number(beatGain.value).toFixed(2);
    bgSpeedVal.textContent = Number(bgSpeed.value).toFixed(2);
    bgGainVal.textContent = Number(bgGain.value).toFixed(2);
  }

  function pickVoice(langCode) {
    const voices = speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;
    const exact = voices.find(v => (v.lang||"").toLowerCase() === langCode.toLowerCase());
    if (exact) return exact;
    const prefix = langCode.split("-")[0].toLowerCase();
    const pref = voices.find(v => (v.lang||"").toLowerCase().startsWith(prefix));
    return pref || voices[0] || null;
  }

  function speak() {
    const t = (text.value || "").trim();
    if (!t) { status.textContent = "Metin boÅŸ."; return; }

    const utter = new SpeechSynthesisUtterance(t);
    utter.lang = lang.value;
    utter.rate = Number(rate.value);
    utter.pitch = Number(pitch.value);

    const m = mood.value;
    if (m === "Hareketli") utter.rate = Math.min(2, utter.rate + 0.15);
    if (m === "HÃ¼zÃ¼nlÃ¼") utter.pitch = Math.max(0, utter.pitch - 0.15);
    if (m === "Damar") utter.pitch = Math.max(0, utter.pitch - 0.10);

    const v = pickVoice(lang.value);
    if (v) utter.voice = v;

    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
    status.textContent = "TTS oynatÄ±lÄ±yorâ€¦";
    utter.onend = () => status.textContent = "TTS bitti.";
    utter.onerror = () => status.textContent = "TTS hata verdi (tarayÄ±cÄ± voice desteÄŸi).";
  }

  // Audio engine
  let ac = null, masterGain = null, musicGainNode = null, micGainNode = null, dest = null;
  let beatTimer = null;
  let uploadEl = new Audio(); uploadEl.loop = true;
  let uploadSrc = null;
  let micStream = null, micSrc = null, micOn = false;

  function ensureAudio() {
    if (ac) return;
    ac = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = ac.createGain();
    musicGainNode = ac.createGain();
    micGainNode = ac.createGain();
    dest = ac.createMediaStreamDestination();

    musicGainNode.connect(masterGain);
    micGainNode.connect(masterGain);
    masterGain.connect(ac.destination);
    masterGain.connect(dest);

    musicGainNode.gain.value = Number(bgGain.value);
    masterGain.gain.value = 0.9;

    uploadSrc = ac.createMediaElementSource(uploadEl);
    uploadSrc.connect(musicGainNode);
  }

  function stopBeat() { if (beatTimer) { clearInterval(beatTimer); beatTimer = null; } }

  function startBuiltInBeat() {
    ensureAudio(); stopBeat();
    const type = beatType.value;
    const baseTempo = Number(tempo.value);
    const speed = Number(bgSpeed.value);
    const intervalMs = Math.max(120, 500 / (baseTempo * speed));

    const kick = () => {
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(120, ac.currentTime);
      o.frequency.exponentialRampToValueAtTime(50, ac.currentTime + 0.12);
      g.gain.setValueAtTime(1.0, ac.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.12);
      o.connect(g); g.connect(musicGainNode);
      o.start(); o.stop(ac.currentTime + 0.13);
    };

    const hat = () => {
      const b = ac.createBuffer(1, ac.sampleRate * 0.03, ac.sampleRate);
      const data = b.getChannelData(0);
      for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * 0.35;
      const src = ac.createBufferSource(); src.buffer = b;
      const hp = ac.createBiquadFilter(); hp.type = "highpass"; hp.frequency.value = 6000;
      const g = ac.createGain(); g.gain.value = 0.25;
      src.connect(hp); hp.connect(g); g.connect(musicGainNode);
      src.start();
    };

    const chord = (freq) => {
      const o1 = ac.createOscillator();
      const o2 = ac.createOscillator();
      const g = ac.createGain();
      const f = ac.createBiquadFilter();
      f.type = (type === "lofi") ? "lowpass" : "bandpass";
      f.frequency.value = (type === "arabesk") ? 900 : 1400;

      o1.type = (type === "trap") ? "sawtooth" : "triangle";
      o2.type = (type === "trap") ? "square" : "sine";
      o1.frequency.value = freq;
      o2.frequency.value = freq * 1.5;

      g.gain.setValueAtTime(0.0001, ac.currentTime);
      g.gain.exponentialRampToValueAtTime(0.18, ac.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + 0.35);

      o1.connect(f); o2.connect(f); f.connect(g); g.connect(musicGainNode);
      o1.start(); o2.start();
      o1.stop(ac.currentTime + 0.36);
      o2.stop(ac.currentTime + 0.36);
    };

    let step = 0;
    beatTimer = setInterval(() => {
      musicGainNode.gain.value = Number(bgGain.value);
      const intensity = Number(beatGain.value);
      if (intensity <= 0.001) { step = (step+1)%16; return; }

      if (step % 4 === 0) kick();
      if (type !== "arabesk") { if (step % 2 === 1) hat(); }
      else { if (step % 4 === 2) hat(); }

      if (step % 8 === 0) {
        const base = (type === "arabesk") ? 220 : (type === "trap" ? 110 : 196);
        const seq = [base, base*1.122, base*1.189, base*1.335];
        chord(seq[(step/8) % seq.length]);
      }
      step = (step + 1) % 16;
    }, intervalMs);

    status.textContent = "HazÄ±r beat Ã§alÄ±yorâ€¦";
  }

  function startUploadMusic(file) {
    ensureAudio(); stopBeat();
    const url = URL.createObjectURL(file);
    uploadEl.src = url;
    uploadEl.playbackRate = Number(bgSpeed.value);
    uploadEl.currentTime = 0;
    uploadEl.play().then(() => status.textContent = "YÃ¼klenen mÃ¼zik Ã§alÄ±yorâ€¦")
      .catch(() => status.textContent = "MÃ¼zik oynatÄ±lamadÄ± (izin).");
  }

  function stopMusic() {
    stopBeat();
    try { uploadEl.pause(); uploadEl.currentTime = 0; } catch {}
    status.textContent = "Fon durdu.";
  }

  async function toggleMic() {
    ensureAudio();
    if (!micOn) {
      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micSrc = ac.createMediaStreamSource(micStream);
        micSrc.connect(micGainNode);
        micOn = true;
        status.textContent = "Mikrofon aÃ§Ä±k (mixâ€™e dahil).";
      } catch {
        status.textContent = "Mikrofon izni verilmedi.";
      }
    } else {
      try { if (micStream) micStream.getTracks().forEach(t => t.stop()); } catch {}
      micOn = false;
      status.textContent = "Mikrofon kapalÄ±.";
    }
  }

  // Recording
  let recorder = null, chunks = [];
  function startRec() {
    ensureAudio();
    chunks = [];
    recorder = new MediaRecorder(dest.stream, { mimeType: "audio/webm" });
    recorder.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: "audio/webm" });
      const url = URL.createObjectURL(blob);
      dl.href = url;
      dl.download = "sumo_mix.webm";
      dl.style.display = "inline-flex";
      status.textContent = "Mix kaydÄ± hazÄ±r (WEBM).";
    };
    recorder.start();
    btnRec.disabled = true;
    btnRecStop.disabled = false;
    dl.style.display = "none";
    status.textContent = "KayÄ±t baÅŸladÄ±â€¦";
  }
  function stopRec() {
    if (recorder && recorder.state === "recording") recorder.stop();
    btnRec.disabled = false;
    btnRecStop.disabled = true;
  }

  // Events
  lang.addEventListener("change", () => fillAccents());
  rate.addEventListener("input", syncLabels);
  pitch.addEventListener("input", syncLabels);
  beatGain.addEventListener("input", syncLabels);
  bgSpeed.addEventListener("input", () => { syncLabels(); uploadEl.playbackRate = Number(bgSpeed.value); });
  bgGain.addEventListener("input", () => { syncLabels(); if (musicGainNode) musicGainNode.gain.value = Number(bgGain.value); });

  $("btnSpeak").addEventListener("click", speak);
  $("btnStopSpeak").addEventListener("click", () => { speechSynthesis.cancel(); status.textContent = "TTS durdu."; });

  $("btnSave").addEventListener("click", () => {
    localStorage.setItem("sumoStudioState", JSON.stringify({
      text:text.value, lang:lang.value, accent:accent.value, rate:Number(rate.value), pitch:Number(pitch.value),
      mood:mood.value, tempo:tempo.value, bgMode:bgMode.value, beatType:beatType.value,
      beatGain:Number(beatGain.value), bgSpeed:Number(bgSpeed.value), bgGain:Number(bgGain.value)
    }));
    status.textContent = "Proje kaydedildi.";
  });

  $("btnLoad").addEventListener("click", () => {
    const s = localStorage.getItem("sumoStudioState");
    if (!s) { status.textContent = "KayÄ±t yok."; return; }
    try {
      const o = JSON.parse(s);
      text.value = o.text ?? text.value;
      lang.value = o.lang ?? lang.value;
      fillAccents();
      accent.value = o.accent ?? accent.value;
      rate.value = String(o.rate ?? 1);
      pitch.value = String(o.pitch ?? 1);
      mood.value = o.mood ?? mood.value;
      tempo.value = o.tempo ?? tempo.value;
      bgMode.value = o.bgMode ?? bgMode.value;
      beatType.value = o.beatType ?? beatType.value;
      beatGain.value = String(o.beatGain ?? 0.6);
      bgSpeed.value = String(o.bgSpeed ?? 1);
      bgGain.value = String(o.bgGain ?? 0.55);
      syncLabels();
      status.textContent = "KayÄ±t yÃ¼klendi.";
    } catch { status.textContent = "KayÄ±t bozuk."; }
  });

  $("btnBgPlay").addEventListener("click", async () => {
    ensureAudio(); await ac.resume();
    const mode = bgMode.value;
    if (mode === "builtIn") startBuiltInBeat();
    else {
      const f = bgFile.files && bgFile.files[0];
      if (!f) { status.textContent = "MÃ¼zik dosyasÄ± seÃ§."; return; }
      startUploadMusic(f);
    }
  });

  $("btnBgStop").addEventListener("click", stopMusic);
  $("btnMic").addEventListener("click", toggleMic);
  $("btnRec").addEventListener("click", startRec);
  $("btnRecStop").addEventListener("click", stopRec);

  // Init
  fillLangs(); syncLabels();
})();
</script>

<!-- Service worker register -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }
</script>
</body>
</html>